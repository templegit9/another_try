<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light">
    <meta name="theme-color" content="#ffffff">
    <title>Platform Engagement Tracker (Supabase)</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        youtubeRed: '#FF0000',
                        serviceNowGreen: '#00c487',
                        linkedinBlue: '#0A66C2',
                    }
                }
            }
        }
    </script>
    <style>
        /* Reset some default styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* Custom badge styling */
        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .badge.youtube {
            background-color: #FFEEEE;
            color: #FF0000;
        }
        .badge.servicenow {
            background-color: #E6F7F1;
            color: #00c487;
        }
        .badge.linkedin {
            background-color: #E6F0FA;
            color: #0A66C2;
        }
        .badge.other {
            background-color: #F3F4F6;
            color: #6B7280;
        }
        /* Button styling */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            font-weight: 500;
            cursor: pointer;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .btn-primary {
            background-color: #00c487;
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #00A070;
        }
        /* Animation */
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Rotation for collapse icons */
        .rotate-180 {
            transform: rotate(180deg);
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            transform: translateX(100%);
            border-color: #00c487;
        }
        .toggle-label {
            transition: background-color 0.2s ease;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #00c487;
        }

        /* Form elements styling */
        input[type="text"],
        input[type="url"],
        input[type="date"],
        input[type="password"],
        input[type="email"],
        select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #D1D5DB; /* Default light mode border */
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            background-color: #ffffff; /* Default light mode background */
            color: #111827; /* Default light mode text */
        }

        input:focus, select:focus {
            outline: 2px solid #00c487;
            border-color: #00c487;
        }

        /* Dark mode styles for inputs/selects */
        .dark input[type="text"],
        .dark input[type="url"],
        .dark input[type="date"],
        .dark input[type="password"],
        .dark input[type="email"],
        .dark select {
            border-color: #4B5563; /* Dark mode border */
            background-color: #374151; /* Dark mode background */
            color: #F9FAFB; /* Dark mode text */
        }

        /* Hide main content initially until authentication is checked */
        #main-content {
            display: none;
        }

        /* Show auth content initially */
        #auth-content {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen transition-colors duration-200">
    <div id="auth-content" class="min-h-screen flex flex-col justify-center">
        <div class="max-w-md mx-auto p-6 w-full">
             <div class="mb-8 text-center">
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Platform Engagement Tracker</h1>
                <p class="text-gray-600 dark:text-gray-400">Track and manage your content performance</p>
            </div>

            <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg p-6">
                <div class="flex border-b border-gray-200 dark:border-gray-700 mb-6">
                    <button id="login-tab" class="px-4 py-2 border-b-2 border-green-500 text-green-600 dark:text-green-400 font-medium">Login</button>
                    <button id="register-tab" class="px-4 py-2 text-gray-500 dark:text-gray-400 font-medium">Register</button>
                </div>

                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
                        <input type="email" id="login-email" name="login-email" required autocomplete="email"
                            class="shadow-sm focus:ring focus:ring-green-500 focus:border-green-500 block w-full sm:text-sm rounded-md p-2">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
                        <input type="password" id="login-password" name="login-password" required autocomplete="current-password"
                            class="shadow-sm focus:ring focus:ring-green-500 focus:border-green-500 block w-full sm:text-sm rounded-md p-2">
                    </div>
                    <div>
                        <button type="submit" class="w-full btn btn-primary">
                            <span class="material-icons mr-1">login</span> Sign in
                        </button>
                    </div>
                    <div id="login-error" class="text-red-500 text-sm hidden"></div>
                </form>

                <form id="register-form" class="space-y-4 hidden">
                    <div>
                        <label for="register-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Full Name</label>
                        <input type="text" id="register-name" name="register-name" required autocomplete="name"
                            class="shadow-sm focus:ring focus:ring-green-500 focus:border-green-500 block w-full sm:text-sm rounded-md p-2">
                    </div>
                    <div>
                        <label for="register-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
                        <input type="email" id="register-email" name="register-email" required autocomplete="email"
                            class="shadow-sm focus:ring focus:ring-green-500 focus:border-green-500 block w-full sm:text-sm rounded-md p-2">
                    </div>
                    <div>
                        <label for="register-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
                        <input type="password" id="register-password" name="register-password" required autocomplete="new-password"
                            class="shadow-sm focus:ring focus:ring-green-500 focus:border-green-500 block w-full sm:text-sm rounded-md p-2">
                    </div>
                    <div>
                        <label for="register-confirm-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Confirm Password</label>
                        <input type="password" id="register-confirm-password" name="register-confirm-password" required autocomplete="new-password"
                            class="shadow-sm focus:ring focus:ring-green-500 focus:border-green-500 block w-full sm:text-sm rounded-md p-2">
                    </div>
                    <div>
                        <button type="submit" class="w-full btn btn-primary">
                            <span class="material-icons mr-1">person_add</span> Create Account
                        </button>
                    </div>
                    <div id="register-error" class="text-red-500 text-sm hidden"></div>
                </form>

                <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-700 dark:text-gray-300">Dark Mode</span>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" id="auth-dark-mode-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-transform duration-200 ease-in"/>
                            <label for="auth-dark-mode-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 dark:bg-gray-600 cursor-pointer"></label>
                        </div>
                    </div>
                </div>
            </div>
             </div>
    </div>

    <div id="main-content">
        <header class="bg-white dark:bg-gray-800 shadow">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Platform Engagement Tracker</h1>
                <div class="flex items-center">
                    <div class="relative ml-3">
                        <div>
                            <button id="user-menu-button" type="button" class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                <span id="current-user-name">User</span>
                                <span class="material-icons ml-1">arrow_drop_down</span>
                            </button>
                        </div>
                         <div id="user-dropdown" class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 focus:outline-none z-50">
                            <a href="#" id="user-profile-link" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <span class="material-icons mr-1 align-text-bottom text-sm">person</span> Your Profile
                            </a>
                            <a href="#" id="show-settings-link" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <span class="material-icons mr-1 align-text-bottom text-sm">settings</span> Settings
                            </a>
                            <button id="logout-button" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <span class="material-icons mr-1 align-text-bottom text-sm">logout</span> Sign out
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                 <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-blue-100 dark:bg-blue-900 rounded-md p-3">
                                <span class="material-icons text-blue-600 dark:text-blue-300">collections</span>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Total Content</dt>
                                    <dd class="flex items-baseline">
                                        <div class="text-2xl font-semibold text-gray-900 dark:text-white" id="total-content">0</div>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-green-100 dark:bg-green-900 rounded-md p-3">
                                <span class="material-icons text-green-600 dark:text-green-300">visibility</span>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Total Engagements</dt>
                                    <dd class="flex items-baseline">
                                        <div class="text-2xl font-semibold text-gray-900 dark:text-white" id="total-engagements">0</div>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-purple-100 dark:bg-purple-900 rounded-md p-3">
                                <span class="material-icons text-purple-600 dark:text-purple-300">trending_up</span>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Top Platform</dt>
                                    <dd class="flex items-baseline">
                                        <div class="text-2xl font-semibold text-gray-900 dark:text-white" id="top-platform">-</div>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-4">
                    <h3 class="text-lg font-medium mb-4 dark:text-white">Engagement by Platform</h3>
                    <div>
                        <canvas id="platform-chart" height="200"></canvas>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-4">
                    <h3 class="text-lg font-medium mb-4 dark:text-white">Top Content by Views</h3>
                    <div>
                        <canvas id="content-chart" height="200"></canvas>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 shadow rounded-lg mb-6">
                <div class="px-4 py-5 sm:p-6">
                    <div class="flex justify-between items-center mb-4 cursor-pointer" id="toggle-add-content">
                        <h3 class="text-lg font-medium dark:text-white">Add New Content</h3>
                        <span class="material-icons text-gray-500 dark:text-gray-400 transform transition-transform duration-200">expand_more</span>
                    </div>
                    <div id="add-content-body" class="hidden transition-all duration-300 overflow-hidden"> <form id="content-form" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                             <div class="md:col-span-2">
                                <label for="content-url" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">URL <span class="text-red-500 dark:text-red-400">*</span></label>
                                <input type="url" id="content-url" name="content-url" required
                                    class="shadow-sm focus:ring focus:ring-green-500 focus:border-green-500 block w-full sm:text-sm rounded-md p-2">
                                <p id="duplicate-warning" class="text-red-500 dark:text-red-400 text-xs mt-1 hidden">Warning: URL already exists</p>
                            </div>
                            <div>
                                <label for="content-source" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Platform <span class="text-red-500 dark:text-red-400">*</span></label>
                                <select id="content-source" name="content-source" required
                                    class="shadow-sm focus:ring focus:ring-green-500 focus:border-green-500 block w-full sm:text-sm rounded-md p-2">
                                    <option value="youtube">YouTube</option>
                                    <option value="servicenow">ServiceNow Community</option>
                                    <option value="linkedin">LinkedIn</option>
                                </select>
                            </div>
                            <div>
                                <label for="fetch-content-info" class="block text-sm font-medium text-transparent mb-1">Get Info</label>
                                <button type="button" id="fetch-content-info"
                                    class="btn bg-blue-100 hover:bg-blue-200 text-blue-700 dark:bg-blue-800 dark:hover:bg-blue-700 dark:text-blue-200 w-full">
                                    <span class="material-icons mr-1">cloud_download</span> Get Info
                                </button>
                            </div>
                            <div class="md:col-span-2">
                                <label for="content-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Title <span class="text-gray-400 dark:text-gray-500 text-xs">(auto-detected, can edit)</span></label>
                                <input type="text" id="content-name" name="content-name" required
                                    class="shadow-sm focus:ring focus:ring-green-500 focus:border-green-500 block w-full sm:text-sm rounded-md p-2"
                                    placeholder="Will be extracted from URL">
                            </div>
                            <div class="md:col-span-2">
                                <label for="content-description" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description <span class="text-gray-400 dark:text-gray-500 text-xs">(optional)</span></label>
                                <input type="text" id="content-description" name="content-description"
                                    class="shadow-sm focus:ring focus:ring-green-500 focus:border-green-500 block w-full sm:text-sm rounded-md p-2"
                                    placeholder="Your notes about this content">
                            </div>
                            <div id="duration-container" class="hidden"> <label for="content-duration" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Duration <span class="text-gray-400 dark:text-gray-500 text-xs">(auto-detected for videos)</span></label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <span class="material-icons text-gray-400 dark:text-gray-500 text-sm">timer</span>
                                    </span>
                                    <input type="text" id="content-duration" name="content-duration"
                                        class="shadow-sm focus:ring focus:ring-green-500 focus:border-green-500 block w-full pl-10 sm:text-sm rounded-md p-2"
                                        placeholder="0:00" readonly>
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                <label for="content-published" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Published Date <span class="text-gray-400 dark:text-gray-500 text-xs">(auto-detected when possible)</span></label>
                                <input type="date" id="content-published" name="content-published" required
                                    class="shadow-sm focus:ring focus:ring-green-500 focus:border-green-500 block w-full sm:text-sm rounded-md p-2">
                            </div>
                            <div class="md:col-span-4">
                                <div class="flex justify-end">
                                    <button type="submit"
                                        class="btn btn-primary">
                                        <span class="material-icons mr-1">add</span> Add Content
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 shadow rounded-lg mb-6">
                <div class="px-4 py-5 sm:p-6">
                    <div class="flex justify-between items-center mb-4">
                         <div class="flex items-center cursor-pointer" id="toggle-content-library">
                            <h3 class="text-lg font-medium dark:text-white">Content Library</h3>
                            <span class="material-icons text-gray-500 dark:text-gray-400 ml-2 transform transition-transform duration-200">expand_more</span>
                        </div>
                        <button id="refresh-data" class="btn btn-primary">
                            <span class="material-icons mr-1">refresh</span> Refresh Data
                        </button>
                    </div>
                    <div id="content-library-body" class="hidden transition-all duration-300 overflow-hidden"> <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Title/Description</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Platform</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Published</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Added On</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">URL</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="content-list" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    <tr><td colspan="6" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">Loading content...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 shadow rounded-lg mb-6">
                 <div class="px-4 py-5 sm:p-6">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center cursor-pointer" id="toggle-engagement-data">
                            <h3 class="text-lg font-medium dark:text-white">Latest Engagement Data</h3>
                            <span class="material-icons text-gray-500 dark:text-gray-400 ml-2 transform transition-transform duration-200">expand_more</span>
                        </div>
                         <button id="refresh-all-data" class="btn btn-primary">
                            <span class="material-icons mr-1">refresh</span> Refresh All
                        </button>
                    </div>
                    <div id="engagement-data-body" class="hidden transition-all duration-300 overflow-hidden"> <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Content</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Platform</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Views</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Total Hours</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Likes</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Comments</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Last Updated</th>
                                    </tr>
                                </thead>
                                <tbody id="engagement-list" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    <tr><td colspan="7" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">Loading engagement data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <div id="api-settings" class="fixed inset-0 bg-gray-600 bg-opacity-75 dark:bg-gray-900 dark:bg-opacity-80 flex items-center justify-center hidden z-50">
            <div class="bg-white dark:bg-gray-800 rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto shadow-xl">
                <div class="px-4 py-5 sm:p-6">
                     <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium dark:text-white">Settings</h3>
                        <button id="hide-settings" class="text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white">
                            <span class="material-icons">close</span>
                        </button>
                    </div>

                    <div class="mb-6">
                         <h4 class="text-md font-medium mb-2 dark:text-white">General Settings</h4>
                         <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <div class="flex items-center justify-between">
                                <label for="dark-mode-toggle" class="text-sm font-medium text-gray-700 dark:text-gray-300">Dark Mode</label>
                                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" id="dark-mode-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-transform duration-200 ease-in"/>
                                    <label for="dark-mode-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 dark:bg-gray-600 cursor-pointer"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-6">
                        <h4 class="text-md font-medium mb-2 flex items-center dark:text-white">
                            YouTube API
                            <span id="youtube-api-status" class="ml-2 badge bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300">Not Configured</span>
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="youtube-api-key" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">API Key</label>
                                <input type="password" id="youtube-api-key" name="youtube-api-key" autocomplete="off"
                                    class="shadow-sm focus:ring focus:ring-green-500 focus:border-green-500 block w-full sm:text-sm rounded-md p-2">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                    Get key from <a href="https://console.developers.google.com/" target="_blank" class="text-blue-500 dark:text-blue-400 hover:underline">Google Cloud Console</a> (Enable YouTube Data API v3).
                                </p>
                            </div>
                            <div class="flex items-end">
                                <button id="test-youtube-api" class="btn bg-gray-100 hover:bg-gray-200 text-gray-700 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200">
                                    <span class="material-icons mr-1 text-sm">check_circle</span> Test
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h4 class="text-md font-medium mb-2 flex items-center dark:text-white">
                            ServiceNow API
                            <span id="servicenow-api-status" class="ml-2 badge bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300">Not Configured</span>
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="servicenow-instance" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Instance URL</label>
                                <input type="text" id="servicenow-instance" name="servicenow-instance" autocomplete="off"
                                    class="shadow-sm focus:ring focus:ring-green-500 focus:border-green-500 block w-full sm:text-sm rounded-md p-2"
                                    placeholder="https://instance.service-now.com">
                            </div>
                            <div>
                                <label for="servicenow-username" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Username</label>
                                <input type="text" id="servicenow-username" name="servicenow-username" autocomplete="off"
                                    class="shadow-sm focus:ring focus:ring-green-500 focus:border-green-500 block w-full sm:text-sm rounded-md p-2">
                            </div>
                            <div>
                                <label for="servicenow-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
                                <input type="password" id="servicenow-password" name="servicenow-password" autocomplete="off"
                                    class="shadow-sm focus:ring focus:ring-green-500 focus:border-green-500 block w-full sm:text-sm rounded-md p-2">
                            </div>
                            <div class="md:col-span-3 flex items-end">
                                <button id="test-servicenow-api" class="btn bg-gray-100 hover:bg-gray-200 text-gray-700 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200">
                                    <span class="material-icons mr-1 text-sm">check_circle</span> Test
                                </button>
                            </div>
                        </div>
                     </div>

                    <div class="mb-6">
                        <h4 class="text-md font-medium mb-2 flex items-center dark:text-white">
                            LinkedIn API
                            <span id="linkedin-api-status" class="ml-2 badge bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300">Not Configured</span>
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="linkedin-client-id" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Client ID</label>
                                <input type="text" id="linkedin-client-id" name="linkedin-client-id" autocomplete="off"
                                    class="shadow-sm focus:ring focus:ring-green-500 focus:border-green-500 block w-full sm:text-sm rounded-md p-2">
                            </div>
                            <div>
                                <label for="linkedin-client-secret" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Client Secret</label>
                                <input type="password" id="linkedin-client-secret" name="linkedin-client-secret" autocomplete="off"
                                    class="shadow-sm focus:ring focus:ring-green-500 focus:border-green-500 block w-full sm:text-sm rounded-md p-2">
                            </div>
                            <div class="md:col-span-2 flex items-end">
                                <button id="test-linkedin-api" class="btn bg-gray-100 hover:bg-gray-200 text-gray-700 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200">
                                    <span class="material-icons mr-1 text-sm">check_circle</span> Test
                                </button>
                            </div>
                        </div>
                     </div>

                    <div class="mt-6">
                        <button id="save-api-config" class="btn btn-primary">
                            <span class="material-icons mr-1">save</span> Save Configuration
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 dark:bg-gray-900 dark:bg-opacity-80 flex items-center justify-center hidden z-50">
            <div class="bg-white dark:bg-gray-800 rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto shadow-xl">
                <div class="px-4 py-5 sm:p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="modal-title" class="text-lg font-medium dark:text-white">Content Details</h3>
                        <button id="close-modal" class="text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white">
                            <span class="material-icons">close</span>
                        </button>
                    </div>
                    <div id="modal-content">
                        <p class="text-gray-500 dark:text-gray-400">Loading details...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="profile-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 dark:bg-gray-900 dark:bg-opacity-80 flex items-center justify-center hidden z-50">
             <div class="bg-white dark:bg-gray-800 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-xl">
                <div class="px-4 py-5 sm:p-6">
                     <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium dark:text-white">Your Profile</h3>
                        <button id="close-profile-modal" class="text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white">
                            <span class="material-icons">close</span>
                        </button>
                    </div>
                    <div class="space-y-6">
                        <div class="flex flex-col items-center mb-6">
                            <div class="w-24 h-24 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center mb-3">
                                <span class="material-icons text-4xl text-green-500 dark:text-green-300">person</span>
                            </div>
                            <h2 id="profile-name" class="text-xl font-semibold text-gray-900 dark:text-white">User Name</h2>
                            <p id="profile-email" class="text-gray-500 dark:text-gray-400">user@example.com</p>
                        </div>

                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg space-y-4">
                            <h4 class="font-medium text-gray-900 dark:text-white">Account Information</h4>
                            <div>
                                <label for="profile-display-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Display Name</label>
                                <input type="text" id="profile-display-name" name="profile-display-name" autocomplete="name"
                                    class="shadow-sm focus:ring focus:ring-green-500 focus:border-green-500 block w-full sm:text-sm rounded-md p-2">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="profile-current-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Current Password <span class="text-xs">(Needed to change password)</span></label>
                                    <input type="password" id="profile-current-password" name="profile-current-password" autocomplete="current-password"
                                        class="shadow-sm focus:ring focus:ring-green-500 focus:border-green-500 block w-full sm:text-sm rounded-md p-2"
                                        placeholder="Enter to change password">
                                </div>
                                <div>
                                    <label for="profile-new-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">New Password</label>
                                    <input type="password" id="profile-new-password" name="profile-new-password" autocomplete="new-password"
                                        class="shadow-sm focus:ring focus:ring-green-500 focus:border-green-500 block w-full sm:text-sm rounded-md p-2"
                                        placeholder="Leave blank to keep current">
                                </div>
                            </div>
                        </div>

                         <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                             <h4 class="font-medium text-gray-900 dark:text-white mb-2">Account Statistics</h4>
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                                <div class="p-3">
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Content Items</p>
                                    <p id="profile-content-count" class="text-xl font-semibold text-gray-900 dark:text-white">0</p>
                                </div>
                                <div class="p-3">
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Total Views</p>
                                    <p id="profile-views-count" class="text-xl font-semibold text-gray-900 dark:text-white">0</p>
                                </div>
                                <div class="p-3">
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Member Since</p>
                                    <p id="profile-member-since" class="text-xl font-semibold text-gray-900 dark:text-white">-</p>
                                </div>
                            </div>
                         </div>

                        <div class="flex justify-end space-x-3">
                            <button id="save-profile" class="btn btn-primary">
                                <span class="material-icons mr-1">save</span> Save Changes
                            </button>
                             <button id="delete-account" class="btn bg-red-500 hover:bg-red-600 text-white">
                                <span class="material-icons mr-1">delete_forever</span> Delete Account
                            </button>
                        </div>
                        <div id="profile-message" class="text-green-500 dark:text-green-400 text-sm hidden"></div>
                    </div>
                </div>
            </div>
        </div>

        <script>
        // ****** START: NEW CODE - Supabase Initialization ******
        // IMPORTANT: Replace with your actual Supabase URL and Anon Key
        // Best practice: Use environment variables in a real app
        const SUPABASE_URL = 'https://nivzsdyvkdkezigvmtqx.supabase.co'; // <-- REPLACE THIS
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pdnpzZHl2a2RrZXppZ3ZtdHF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMxMjIwMTAsImV4cCI6MjA1ODY5ODAxMH0.Yb9a9MkU_iNc9G7iX04Kr6lDlSbSLS2go-zb_R5cCtA'; // <-- REPLACE THIS

        if (!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_URL === 'YOUR_SUPABASE_URL') {
            alert("Supabase URL and Anon Key are required! Please update them in the script.");
            console.error("Supabase URL and Key are required!");
            // Optionally disable the app or show an error message to the user
        }

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        // ****** END: NEW CODE - Supabase Initialization ******

        // Constants
        const PLATFORMS = {
            youtube: 'Youtube',
            servicenow: 'ServiceNow Community blog page',
            linkedin: 'LinkedIn'
        };

        // Data structures (Populated from Supabase)
        let apiConfig = {}; // { platform: config_json }
        let currentUser = null; // Supabase user session/object
        let contentItems = [];
        let engagementData = [];

        // Chart instances
        let platformChart;
        let contentChart;

        // DOM elements
        const authContent = document.getElementById('auth-content');
        const mainContent = document.getElementById('main-content');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginTab = document.getElementById('login-tab');
        const registerTab = document.getElementById('register-tab');
        const loginError = document.getElementById('login-error');
        const registerError = document.getElementById('register-error');
        const authDarkModeToggle = document.getElementById('auth-dark-mode-toggle');
        const contentForm = document.getElementById('content-form');
        const contentUrlField = document.getElementById('content-url');
        const duplicateWarning = document.getElementById('duplicate-warning');
        const contentList = document.getElementById('content-list');
        const engagementList = document.getElementById('engagement-list');
        const userMenuButton = document.getElementById('user-menu-button');
        const userDropdown = document.getElementById('user-dropdown');
        const currentUserName = document.getElementById('current-user-name');
        const logoutButton = document.getElementById('logout-button');
        const userProfileLink = document.getElementById('user-profile-link');
        // Import/Export buttons removed from DOM refs
        const refreshDataBtn = document.getElementById('refresh-data');
        const refreshAllDataBtn = document.getElementById('refresh-all-data');
        const showSettingsBtn = document.getElementById('show-settings-link');
        const hideSettingsBtn = document.getElementById('hide-settings');
        const apiSettingsSection = document.getElementById('api-settings');
        const saveApiConfigBtn = document.getElementById('save-api-config');
        const testYouTubeApiBtn = document.getElementById('test-youtube-api');
        const testServiceNowApiBtn = document.getElementById('test-servicenow-api');
        const testLinkedInApiBtn = document.getElementById('test-linkedin-api');
        const contentModal = document.getElementById('content-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const profileModal = document.getElementById('profile-modal');
        const closeProfileModalBtn = document.getElementById('close-profile-modal');
        const profileName = document.getElementById('profile-name');
        const profileEmail = document.getElementById('profile-email');
        const profileDisplayName = document.getElementById('profile-display-name');
        const profileContentCount = document.getElementById('profile-content-count');
        const profileViewsCount = document.getElementById('profile-views-count');
        const profileMemberSince = document.getElementById('profile-member-since');
        const saveProfileBtn = document.getElementById('save-profile');
        const deleteAccountBtn = document.getElementById('delete-account');
        const profileMessage = document.getElementById('profile-message');
        const totalContentEl = document.getElementById('total-content');
        const totalEngagementsEl = document.getElementById('total-engagements');
        const topPlatformEl = document.getElementById('top-platform');
        const darkModeToggle = document.getElementById('dark-mode-toggle'); // Ensure this exists in the settings modal HTML


        // Initialize the app
        async function initApp() {
            // Set up auth UI event listeners
            // Inside the initApp function:
            // Set up auth UI event listeners
            loginTab.addEventListener('click', () => {
                 // Style the login tab as active
                 loginTab.classList.add('border-b-2', 'border-green-500', 'text-green-600', 'dark:text-green-400');
                 loginTab.classList.remove('text-gray-500', 'dark:text-gray-400');
                 // Style the register tab as inactive
                 registerTab.classList.remove('border-b-2', 'border-green-500', 'text-green-600', 'dark:text-green-400');
                 registerTab.classList.add('text-gray-500', 'dark:text-gray-400');
                 // Show the login form and hide the register form
                 loginForm.classList.remove('hidden');
                 registerForm.classList.add('hidden');
             });
             registerTab.addEventListener('click', () => {
                 // Style the register tab as active
                 registerTab.classList.add('border-b-2', 'border-green-500', 'text-green-600', 'dark:text-green-400');
                 registerTab.classList.remove('text-gray-500', 'dark:text-gray-400');
                 // Style the login tab as inactive
                 loginTab.classList.remove('border-b-2', 'border-green-500', 'text-green-600', 'dark:text-green-400');
                 loginTab.classList.add('text-gray-500', 'dark:text-gray-400');
                 // Show the register form and hide the login form
                 registerForm.classList.remove('hidden');
                 loginForm.classList.add('hidden');
             });
            loginForm.addEventListener('submit', handleLogin); // Handles form submission
            registerForm.addEventListener('submit', handleRegister); // Handles form submission
    
            // ... rest of initApp logic ...

            // Dark mode setup
            const prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const savedDarkMode = localStorage.getItem('darkMode') === 'true';
            if (savedDarkMode || (localStorage.getItem('darkMode') === null && prefersDarkMode)) {
                document.documentElement.classList.add('dark');
                if (authDarkModeToggle) authDarkModeToggle.checked = true;
                if (darkModeToggle) darkModeToggle.checked = true;
            }
             if(authDarkModeToggle) authDarkModeToggle.addEventListener('change', handleDarkModeToggle);
             if(darkModeToggle) darkModeToggle.addEventListener('change', handleDarkModeToggle);


            // Listen for Supabase auth state changes
            supabase.auth.onAuthStateChange(async (event, session) => {
                console.log('Auth event:', event, session);
                const wasLoggedIn = !!currentUser; // Check if user was already logged in

                if (event === 'SIGNED_IN' && session) {
                    currentUser = session.user;
                    console.log("User signed in:", currentUser);
                    currentUserName.textContent = currentUser.user_metadata?.name || currentUser.email;
                    authContent.style.display = 'none';
                    mainContent.style.display = 'block';
                    await loadUserData();
                    if (!wasLoggedIn) { // Only setup main listeners once on initial sign-in
                        setupMainAppEventListeners();
                    }
                } else if (event === 'SIGNED_OUT') {
                     handleSignedOutState();
                } else if (event === 'USER_UPDATED') {
                    // Refresh user object if metadata changed
                    currentUser = session.user;
                    currentUserName.textContent = currentUser.user_metadata?.name || currentUser.email;
                }
            });

            // Check initial session state
             try {
                 const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                 if (sessionError) throw sessionError;

                 if (session) {
                     console.log("Existing session found:", session);
                     currentUser = session.user;
                     authContent.style.display = 'none';
                     mainContent.style.display = 'block';
                     currentUserName.textContent = currentUser.user_metadata?.name || currentUser.email;
                     await loadUserData();
                     setupMainAppEventListeners();
                 } else {
                     console.log("No active session");
                     handleSignedOutState(); // Ensure UI is in logged-out state
                 }
             } catch (error) {
                 console.error("Error getting initial session:", error);
                 handleSignedOutState(); // Show auth screen on error
             }

            // Setup collapsible sections
            setupCollapsibleSections();
        }

        function handleSignedOutState() {
             currentUser = null;
             authContent.style.display = 'block';
             mainContent.style.display = 'none';
             contentList.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">Please log in to view content.</td></tr>';
             engagementList.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">Please log in to view data.</td></tr>';
             if (platformChart) platformChart.destroy();
             if (contentChart) contentChart.destroy();
             platformChart = null; // Ensure variables are reset
             contentChart = null;
             apiConfig = {};
             contentItems = [];
             engagementData = [];
             updateStats(); // Reset stats display
        }


        // Handle login form submission
        async function handleLogin(e) {
            e.preventDefault();
            loginError.textContent = ''; // Clear previous errors
            loginError.classList.add('hidden');
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const button = e.target.querySelector('button[type="submit"]');
            button.disabled = true;
            button.innerHTML = '<span class="material-icons animate-spin mr-1">refresh</span> Signing in...';

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password,
                });

                if (error) throw error;
                 console.log('Login successful:', data);
                 // UI transition handled by onAuthStateChange
                 loginForm.reset();
            } catch (error) {
                console.error('Login error:', error.message);
                loginError.textContent = `Login failed: ${error.message}`;
                loginError.classList.remove('hidden');
            } finally {
                 button.disabled = false;
                 button.innerHTML = '<span class="material-icons mr-1">login</span> Sign in';
            }
        }

        // Handle register form submission
        async function handleRegister(e) {
            e.preventDefault();
            registerError.textContent = ''; // Clear previous errors
            registerError.classList.add('hidden');
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            const button = e.target.querySelector('button[type="submit"]');

            if (password !== confirmPassword) {
                registerError.textContent = 'Passwords do not match';
                registerError.classList.remove('hidden');
                return;
            }
             if (password.length < 6) { // Example: Enforce minimum password length
                 registerError.textContent = 'Password must be at least 6 characters long.';
                 registerError.classList.remove('hidden');
                 return;
             }

            button.disabled = true;
            button.innerHTML = '<span class="material-icons animate-spin mr-1">refresh</span> Creating account...';

            try {
                 const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: { data: { name: name } } // Store name in metadata
                });

                 if (error) throw error;

                console.log('Registration successful:', data);
                 // Check if email confirmation is required by Supabase settings
                 const confirmationRequired = data.user && !data.user.email_confirmed_at;

                registerError.textContent = confirmationRequired
                    ? 'Registration successful! Please check your email to confirm your account.'
                    : 'Account created successfully! Please log in.';

                registerError.classList.remove('hidden');
                registerError.classList.remove('text-red-500');
                registerError.classList.add('text-green-500'); // Style as success
                registerForm.reset();
                 if (!confirmationRequired) {
                    loginTab.click(); // Switch to login if no confirmation needed
                 }

            } catch (error) {
                console.error('Registration error:', error.message);
                registerError.textContent = `Registration failed: ${error.message}`;
                registerError.classList.remove('hidden');
                registerError.classList.remove('text-green-500');
                registerError.classList.add('text-red-500');
            } finally {
                 button.disabled = false;
                 button.innerHTML = '<span class="material-icons mr-1">person_add</span> Create Account';
            }
        }

        // Load user data from Supabase
         async function loadUserData() {
            if (!currentUser) {
                console.log("loadUserData called without user.");
                handleSignedOutState(); // Ensure UI reflects logged-out state
                return;
            }
             console.log("Loading user data for:", currentUser.id);
             // Show loading indicators
             contentList.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">Loading content...</td></tr>';
             engagementList.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">Loading engagement data...</td></tr>';


            try {
                // Fetch API Config, Content Items, Engagement Data in parallel
                const [apiResult, contentResult, engagementResult] = await Promise.all([
                    // 1. Fetch API Config
                    supabase
                        .from('api_config')
                        .select('platform, config')
                        .eq('user_id', currentUser.id),
                    // 2. Fetch Content Items
                    supabase
                        .from('content_items')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('created_at', { ascending: false }),
                    // 3. Fetch Engagement Data (conditionally based on content items later)
                    // We fetch content first, then engagement based on content IDs
                     Promise.resolve({ data: [], error: null }) // Placeholder for now
                 ]);

                // Process API Config results
                if (apiResult.error) throw apiResult.error;
                apiConfig = {}; // Reset local config
                (apiResult.data || []).forEach(item => {
                    apiConfig[item.platform] = item.config;
                });
                updateApiConfigUI();

                // Process Content Items results
                if (contentResult.error) throw contentResult.error;
                contentItems = contentResult.data || [];

                 // Fetch Engagement Data based on fetched Content Items
                 let fetchedEngagementData = [];
                 if (contentItems.length > 0) {
                     const contentIds = contentItems.map(item => item.id);
                     const { data: engagementDataResult, error: engagementError } = await supabase
                         .from('engagement_data')
                         .select('*')
                         .in('content_id', contentIds)
                         .order('timestamp', { ascending: false });

                     if (engagementError) throw engagementError;
                     fetchedEngagementData = engagementDataResult || [];
                 }
                 engagementData = fetchedEngagementData;


                // Set default date for form
                document.getElementById('content-published').valueAsDate = new Date();

                // Render fetched data
                renderContentItems();
                renderEngagementData();
                updateStats();
                renderCharts();

            } catch (error) {
                console.error("Error loading user data:", error);
                showNotification(`Failed to load user data: ${error.message}`, 'error');
                 // Clear lists on error
                 contentList.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500 dark:text-red-400">Error loading content.</td></tr>';
                 engagementList.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-red-500 dark:text-red-400">Error loading engagement data.</td></tr>';
            }
        }


        // Setup main app event listeners
         function setupMainAppEventListeners() {
             console.log("Setting up main app event listeners");
             // User menu dropdown
             userMenuButton.addEventListener('click', () => userDropdown.classList.toggle('hidden'));
             document.addEventListener('click', (e) => { // Close dropdown on outside click
                 if (!userMenuButton.contains(e.target) && !userDropdown.contains(e.target)) {
                     userDropdown.classList.add('hidden');
                 }
             });

             // Auth related
             logoutButton.addEventListener('click', handleLogout);
             userProfileLink.addEventListener('click', showUserProfile);
             closeProfileModalBtn.addEventListener('click', () => profileModal.classList.add('hidden'));
             saveProfileBtn.addEventListener('click', saveUserProfile);
             deleteAccountBtn.addEventListener('click', confirmDeleteAccount);

             // Content form
             contentForm.addEventListener('submit', handleContentFormSubmit);
             contentUrlField.addEventListener('blur', checkForDuplicateUrl);
             document.getElementById('fetch-content-info').addEventListener('click', fetchContentInfo);

             // Data actions (Refresh only)
             refreshDataBtn.addEventListener('click', refreshEngagementDataForAllUserItems); // Both buttons refresh all now
             refreshAllDataBtn.addEventListener('click', refreshEngagementDataForAllUserItems);

             // Settings and modals
             saveApiConfigBtn.addEventListener('click', saveApiConfig);
             testYouTubeApiBtn.addEventListener('click', testYouTubeApi);
             testServiceNowApiBtn.addEventListener('click', testServiceNowApi);
             testLinkedInApiBtn.addEventListener('click', testLinkedInApi);
             closeModalBtn.addEventListener('click', () => contentModal.classList.add('hidden'));
             showSettingsBtn.addEventListener('click', () => {
                 apiSettingsSection.classList.remove('hidden');
                 userDropdown.classList.add('hidden'); // Close dropdown when opening settings
             });
             hideSettingsBtn.addEventListener('click', () => apiSettingsSection.classList.add('hidden'));

             // Platform selection updates URL placeholder and duration visibility
             document.getElementById('content-source').addEventListener('change', handlePlatformChange);
             handlePlatformChange(); // Call initially

             // Ensure dark mode toggle in settings is interactive if it wasn't already set up
             if(darkModeToggle && !darkModeToggle.getAttribute('listener')) {
                 darkModeToggle.addEventListener('change', handleDarkModeToggle);
                 darkModeToggle.setAttribute('listener', 'true');
             }
             // Check dark mode state and update toggle
             darkModeToggle.checked = document.documentElement.classList.contains('dark');
        }


        function handleDarkModeToggle(e) {
             const isDarkMode = e.target.checked;
             toggleDarkMode(isDarkMode); // Use a separate function

             // Keep toggles in sync
             const otherToggleId = e.target.id === 'dark-mode-toggle' ? 'auth-dark-mode-toggle' : 'dark-mode-toggle';
             const otherToggle = document.getElementById(otherToggleId);
             if (otherToggle) {
                 otherToggle.checked = isDarkMode;
             }
         }

        function toggleDarkMode(enableDark) {
             if (enableDark) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('darkMode', 'true');
             } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('darkMode', 'false');
             }
             updateChartsForColorMode(); // Update chart colors
        }


         function updateChartsForColorMode() {
             const isDarkMode = document.documentElement.classList.contains('dark');
             const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
             const textColor = isDarkMode ? '#cbd5e1' : '#4b5563'; // Use Tailwind gray colors

             const chartOptionsUpdate = {
                 plugins: {
                     legend: { labels: { color: textColor } }
                 },
                 scales: {
                     x: {
                         ticks: { color: textColor },
                         grid: { color: gridColor }
                     },
                     y: {
                         ticks: { color: textColor },
                         grid: { color: gridColor }
                     }
                 }
             };

             if (platformChart) {
                 platformChart.options.plugins.legend.labels.color = textColor;
                 platformChart.update();
             }
             if (contentChart) {
                 contentChart.options.plugins.legend.labels.color = textColor; // Bar chart might not have legend
                 contentChart.options.scales.x.ticks.color = textColor;
                 contentChart.options.scales.y.ticks.color = textColor;
                 contentChart.options.scales.x.grid.color = gridColor;
                 contentChart.options.scales.y.grid.color = gridColor;
                 contentChart.update();
             }
         }


        function handlePlatformChange() {
             updateUrlPlaceholder();
             const platform = document.getElementById('content-source').value;
             const durationContainer = document.getElementById('duration-container');
             if (platform === 'youtube') {
                 durationContainer.classList.remove('hidden');
             } else {
                 durationContainer.classList.add('hidden');
             }
         }


        // Show user profile
        function showUserProfile() {
            if (!currentUser) return;
            userDropdown.classList.add('hidden');

            profileName.textContent = currentUser.user_metadata?.name || currentUser.email;
            profileEmail.textContent = currentUser.email;
            profileDisplayName.value = currentUser.user_metadata?.name || '';

            profileContentCount.textContent = contentItems.length;
            // Calculate total views from the latest engagement record for each *content_id*
            let totalViews = 0;
            const latestEngagementByContentId = {};
             engagementData.forEach(engagement => {
                 if (!latestEngagementByContentId[engagement.content_id] ||
                     new Date(engagement.timestamp) > new Date(latestEngagementByContentId[engagement.content_id].timestamp)) {
                     latestEngagementByContentId[engagement.content_id] = engagement;
                 }
             });
            Object.values(latestEngagementByContentId).forEach(engagement => {
                totalViews += (engagement.views || 0);
            });
            profileViewsCount.textContent = totalViews.toLocaleString();

            const memberSince = new Date(currentUser.created_at);
            profileMemberSince.textContent = memberSince.toLocaleDateString();

            document.getElementById('profile-current-password').value = '';
            document.getElementById('profile-new-password').value = '';
            profileMessage.textContent = '';
            profileMessage.classList.add('hidden');

            profileModal.classList.remove('hidden');
        }

        // Save user profile
        async function saveUserProfile() {
            if (!currentUser) return;
            profileMessage.textContent = '';
            profileMessage.classList.add('hidden');
            const newDisplayName = profileDisplayName.value.trim();
            const currentPassword = document.getElementById('profile-current-password').value;
            const newPassword = document.getElementById('profile-new-password').value;
            const button = document.getElementById('save-profile');
            button.disabled = true;

            let updateData = {};
            let passwordChanged = false;

            // Check display name change
            if (newDisplayName && newDisplayName !== (currentUser.user_metadata?.name || '')) {
                updateData.data = { ...currentUser.user_metadata, name: newDisplayName };
            }

            // Check password change
            if (newPassword) {
                if (newPassword.length < 6) {
                     showProfileMessage('New password must be at least 6 characters long.', 'error');
                     button.disabled = false;
                     return;
                }
                // Note: Supabase updateUser doesn't strictly require current password,
                // but asking in the UI is good practice. We don't verify it here against Supabase.
                updateData.password = newPassword;
                passwordChanged = true;
            }

            if (Object.keys(updateData).length > 0) {
                 try {
                     const { data, error } = await supabase.auth.updateUser(updateData);
                     if (error) throw error;

                     console.log("Profile updated successfully:", data);
                     // No need to update currentUser locally, onAuthStateChange handles USER_UPDATED
                     showProfileMessage('Profile updated successfully', 'success');

                     if (passwordChanged) {
                         document.getElementById('profile-current-password').value = '';
                         document.getElementById('profile-new-password').value = '';
                     }
                 } catch (error) {
                     console.error("Error updating profile:", error);
                     showProfileMessage(`Error updating profile: ${error.message}`, 'error');
                 } finally {
                     button.disabled = false;
                 }
            } else {
                showProfileMessage('No changes detected.', 'info');
                button.disabled = false;
            }
        }

         function showProfileMessage(message, type = 'info') {
             profileMessage.textContent = message;
             profileMessage.className = 'text-sm mt-2'; // Reset classes
             if (type === 'success') {
                 profileMessage.classList.add('text-green-500', 'dark:text-green-400');
             } else if (type === 'error') {
                 profileMessage.classList.add('text-red-500', 'dark:text-red-400');
             } else {
                 profileMessage.classList.add('text-gray-600', 'dark:text-gray-400');
             }
             profileMessage.classList.remove('hidden');
             setTimeout(() => profileMessage.classList.add('hidden'), 3000);
         }

        // Confirm account deletion
        function confirmDeleteAccount() {
            if (confirm('Are you sure you want to delete your account? This action cannot be undone and requires backend setup.')) {
                deleteAccount();
            }
        }

        // Delete user account (Requires Backend Function)
        async function deleteAccount() {
            showNotification("Account deletion requires secure backend function.", 'error');
            console.warn("Account deletion requires backend logic for security.");
            // See previous explanation: This needs a Supabase Edge Function using the Admin Client.
        }

        // Handle logout
        async function handleLogout() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error("Error logging out:", error);
                showNotification(`Logout failed: ${error.message}`, 'error');
            } else {
                console.log("Logged out successfully");
                // UI transition handled by onAuthStateChange
            }
        }

        // Normalize URL
        function normalizeUrl(url) {
             try {
                const urlObj = new URL(url);
                urlObj.searchParams.delete('utm_source');
                urlObj.searchParams.delete('utm_medium');
                urlObj.searchParams.delete('utm_campaign');
                urlObj.searchParams.delete('utm_content');
                urlObj.searchParams.delete('utm_term');
                urlObj.searchParams.delete('feature');
                urlObj.searchParams.delete('si'); // YouTube share ID
                urlObj.hash = '';
                 // Lowercase hostname and pathname for consistency
                 return urlObj.protocol + '//' + urlObj.hostname.toLowerCase() + urlObj.pathname.toLowerCase() + urlObj.search;
            } catch (e) {
                console.warn("Could not normalize URL:", url, e);
                return url.toLowerCase(); // Basic fallback
            }
        }

        // Check for duplicate URL using Supabase
        async function checkForDuplicateUrl() {
            const url = contentUrlField.value;
            if (!url || !currentUser) return;

            const normalizedUrl = normalizeUrl(url);
            duplicateWarning.classList.add('hidden');

            try {
                const { data: existingContent, error } = await supabase
                    .from('content_items')
                    .select('id, name')
                    .eq('user_id', currentUser.id)
                    .eq('url', normalizedUrl) // Query using normalized URL
                    .maybeSingle();

                if (error) throw error;

                if (existingContent) {
                    duplicateWarning.textContent = `Warning: URL already added as "${existingContent.name}".`;
                    duplicateWarning.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error checking for duplicate URL:", error);
                // Optionally show a generic error to the user if needed
            }
        }

        // Update URL placeholder
        function updateUrlPlaceholder() {
            const platform = document.getElementById('content-source').value;
            const urlField = document.getElementById('content-url');
            switch (platform) {
                case 'youtube': urlField.placeholder = 'youtu.be'; break;
                case 'servicenow': urlField.placeholder = 'https://community.servicenow.com/blog/XXXX'; break;
                case 'linkedin': urlField.placeholder = 'https://www.linkedin.com/posts/XXXX'; break;
                default: urlField.placeholder = 'https://example.com';
            }
        }

        // Fetch content information (title, date, duration)
        async function fetchContentInfo() {
            const contentUrl = document.getElementById('content-url').value;
            const platform = document.getElementById('content-source').value;

            if (!contentUrl) {
                showNotification('Please enter a URL first', 'error');
                return;
            }

            const fetchButton = document.getElementById('fetch-content-info');
            fetchButton.disabled = true;
            fetchButton.innerHTML = '<span class="material-icons animate-spin">refresh</span> Loading...';

            try {
                const contentId = extractContentId(contentUrl, platform);
                let contentInfo = null;

                switch (platform) {
                    case 'youtube':
                         if (!apiConfig.youtube?.apiKey) throw new Error('YouTube API key not configured in Settings.');
                        contentInfo = await fetchYouTubeContentInfo(contentId);
                        break;
                    case 'servicenow':
                         // Use placeholder/simulation until real API call is implemented
                         if (!apiConfig.servicenow?.instance) throw new Error('ServiceNow instance not configured.');
                         console.log("Simulating ServiceNow Info Fetch");
                         await new Promise(res => setTimeout(res, 500)); // Simulate delay
                         contentInfo = { title: `ServiceNow Blog: ${contentId}`, publishedDate: new Date() };
                         break;
                    case 'linkedin':
                         // Use placeholder/simulation until real API call is implemented
                         if (!apiConfig.linkedin?.clientId) throw new Error('LinkedIn API not configured.');
                         console.log("Simulating LinkedIn Info Fetch");
                          await new Promise(res => setTimeout(res, 500)); // Simulate delay
                         contentInfo = { title: `LinkedIn Post: ${contentId}`, publishedDate: new Date() };
                         break;
                    default: contentInfo = { title: '', publishedDate: null };
                }

                if (contentInfo) {
                    document.getElementById('content-name').value = contentInfo.title || '';
                    if (contentInfo.publishedDate) {
                        // Ensure date is valid before setting
                         try {
                             document.getElementById('content-published').valueAsDate = new Date(contentInfo.publishedDate);
                         } catch (e) {
                             console.error("Invalid published date received:", contentInfo.publishedDate);
                             document.getElementById('content-published').value = ''; // Clear if invalid
                         }
                    }
                     if (contentInfo.duration && platform === 'youtube') {
                        document.getElementById('content-duration').value = contentInfo.duration;
                     } else {
                         document.getElementById('content-duration').value = '';
                     }
                     handlePlatformChange(); // Update duration visibility
                }
                showNotification('Content information fetched successfully', 'success');
            } catch (error) {
                console.error('Error fetching content info:', error);
                showNotification(`Error fetching content info: ${error.message}`, 'error');
            } finally {
                fetchButton.disabled = false;
                fetchButton.innerHTML = '<span class="material-icons mr-1">cloud_download</span> Get Info';
            }
        }

        // Fetch YouTube video information
        async function fetchYouTubeContentInfo(videoId) {
            const apiKey = apiConfig.youtube?.apiKey; // Safely access key
            if (!apiKey) throw new Error('YouTube API key missing');

            const videoInfoUrl = `https://www.googleapis.com/youtube/v3/videos?part=snippet,contentDetails&id=${videoId}&key=${apiKey}`;
            const response = await fetch(videoInfoUrl);
            if (!response.ok) {
                 const errorData = await response.json().catch(() => ({})); // Try to get error details
                 console.error("YouTube API Error Response:", errorData);
                 throw new Error(`YouTube API Error: ${response.status} ${response.statusText}. ${errorData.error?.message || ''}`);
            }
            const data = await response.json();
            if (!data.items || data.items.length === 0) throw new Error('Video not found or private');

            const snippet = data.items[0].snippet;
            const contentDetails = data.items[0].contentDetails;
            const duration = contentDetails?.duration ? formatYouTubeDuration(contentDetails.duration) : '';

            return {
                title: snippet.title,
                publishedDate: new Date(snippet.publishedAt),
                duration: duration
            };
        }

        // Format YouTube ISO 8601 duration
        function formatYouTubeDuration(isoDuration) {
            const match = isoDuration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
            if (!match) return '';
            const hours = parseInt(match[1] || 0);
            const minutes = parseInt(match[2] || 0);
            const seconds = parseInt(match[3] || 0);
            let formatted = '';
            if (hours > 0) {
                 formatted += `${hours}:${minutes.toString().padStart(2, '0')}:`;
            } else {
                 formatted += `${minutes}:`;
            }
            formatted += seconds.toString().padStart(2, '0');
            return formatted;
        }

        // Handle content form submission
        async function handleContentFormSubmit(e) {
            e.preventDefault();
            if (!currentUser) {
                showNotification("Please log in to add content.", 'error');
                return;
            }
             const button = e.target.querySelector('button[type="submit"]');
             button.disabled = true;

            const contentName = document.getElementById('content-name').value;
            const contentUrl = document.getElementById('content-url').value;
            const platform = document.getElementById('content-source').value;
            const publishedDate = document.getElementById('content-published').value;
            const description = document.getElementById('content-description').value || null;
            const duration = platform === 'youtube' ? document.getElementById('content-duration').value : null;
            const normalizedUrl = normalizeUrl(contentUrl);

             if (!contentName || !contentUrl || !platform || !publishedDate) {
                 showNotification('Please fill in all required fields (*).', 'error');
                 button.disabled = false;
                 return;
             }

            try {
                 // Check for duplicate URL again before inserting
                 const { data: existingContent, error: checkError } = await supabase
                    .from('content_items')
                    .select('id, name')
                    .eq('user_id', currentUser.id)
                    .eq('url', normalizedUrl)
                    .maybeSingle();
                 if (checkError) throw checkError;

                 if (existingContent) {
                    if (confirm(`This URL exists as "${existingContent.name}". Update it?`)) {
                         const { error: updateError } = await supabase
                            .from('content_items')
                            .update({
                                name: contentName, description: description, published_date: publishedDate,
                                duration: duration, last_updated: new Date().toISOString()
                            })
                            .eq('id', existingContent.id);
                         if (updateError) throw updateError;
                         showNotification('Content updated successfully', 'success');
                         await loadUserData(); // Reload data
                     }
                 } else {
                    // Insert new content
                    const contentId = extractContentId(contentUrl, platform);
                    const newContentData = {
                        user_id: currentUser.id, name: contentName, description: description,
                        platform: platform, url: contentUrl, content_id: contentId,
                        published_date: publishedDate, duration: duration,
                    };
                     const { data: insertedData, error: insertError } = await supabase
                        .from('content_items')
                        .insert(newContentData).select().single();
                     if (insertError) throw insertError;

                     console.log("Content added:", insertedData);
                     showNotification('Content added successfully', 'success');

                     // Add locally or reload
                     contentItems.unshift(insertedData); // Add to start of local array
                     renderContentItems(); // Re-render immediately
                     updateStats(); // Update stats immediately

                     // Fetch initial engagement (async, don't wait for UI)
                     fetchEngagementData([insertedData]).then(() => {
                         console.log("Initial engagement fetched for new item");
                         // Optionally update engagement list/charts if needed after fetch
                         renderEngagementData();
                         renderCharts();
                         updateStats(); // Update stats again after engagement fetch
                     }).catch(err => console.error("Error fetching initial engagement:", err));
                 }

                // Reset form
                contentForm.reset();
                document.getElementById('content-published').valueAsDate = new Date();
                duplicateWarning.classList.add('hidden');
                handlePlatformChange(); // Reset duration visibility

            } catch (error) {
                console.error("Error saving content:", error);
                showNotification(`Failed to save content: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
            }
        }

        // Extract content ID from URL
        function extractContentId(url, platform) {
             try {
                 const urlObj = new URL(url);
                 switch (platform) {
                    case 'youtube':
                        let videoId = urlObj.searchParams.get('v');
                        if (videoId) return videoId;
                        if (urlObj.hostname === 'youtu.be') return urlObj.pathname.substring(1);
                        if (urlObj.pathname.includes('/embed/')) return urlObj.pathname.split('/embed/')[1].split('/')[0];
                        if (urlObj.pathname.includes('/shorts/')) return urlObj.pathname.split('/shorts/')[1].split('/')[0];
                        if (urlObj.pathname.includes('/live/')) return urlObj.pathname.split('/live/')[1].split('/')[0];
                        console.warn("Falling back to last path segment for YouTube ID");
                        return urlObj.pathname.split('/').filter(Boolean).pop(); // Fallback
                    case 'servicenow': return urlObj.pathname.split('/').filter(Boolean).pop(); // Usually last part
                    case 'linkedin':
                         const linkedInMatch = url.match(/urn:li:activity:(\d+)|posts\/([^\/?]+)/);
                         if (linkedInMatch) return linkedInMatch[1] || linkedInMatch[2];
                         console.warn("Could not extract LinkedIn ID reliably");
                         return urlObj.pathname.split('/').filter(Boolean).pop(); // Fallback
                    default: return url; // Return full URL if platform unknown
                 }
            } catch (e) {
                 console.error('Error extracting content ID:', e);
                 return url; // Fallback on error
            }
        }

        // Fetch engagement data and save to Supabase
        async function fetchEngagementData(itemsToFetch) {
             if (!itemsToFetch || itemsToFetch.length === 0 || !currentUser) return;
             console.log(`Workspaceing engagement for ${itemsToFetch.length} items...`);

             const timestamp = new Date().toISOString();
             let engagementRecordsToInsert = [];
             let contentItemsToUpdate = [];

            for (const item of itemsToFetch) {
                let metrics = null;
                try {
                    switch (item.platform) {
                        case 'youtube':
                            if (!apiConfig.youtube?.apiKey) continue; // Skip if no key
                            metrics = await fetchYouTubeEngagement(item.content_id);
                            break;
                        case 'servicenow':
                            // Simulate ServiceNow fetch
                            if (!apiConfig.servicenow?.instance) continue;
                             await new Promise(res => setTimeout(res, 200)); // Simulate delay
                             const snSeed = hashCode(item.content_id);
                             const snRng = seededRandom(snSeed);
                             metrics = { views: Math.floor(snRng() * 3000) + 1000, likes: Math.floor(snRng() * 200), comments: Math.floor(snRng() * 50), shares: Math.floor(snRng() * 30), otherMetrics: { bookmarks: Math.floor(snRng() * 40) }};
                            break;
                        case 'linkedin':
                             // Simulate LinkedIn fetch
                            if (!apiConfig.linkedin?.clientId) continue;
                             await new Promise(res => setTimeout(res, 200)); // Simulate delay
                             const liSeed = hashCode(item.content_id);
                             const liRng = seededRandom(liSeed);
                             metrics = { views: Math.floor(liRng() * 2000) + 500, likes: Math.floor(liRng() * 150), comments: Math.floor(liRng() * 30), shares: Math.floor(liRng() * 20), otherMetrics: { impressions: Math.floor(liRng() * 5000), clicks: Math.floor(liRng() * 200) }};
                            break;
                        default: metrics = { views: 0, likes: 0, comments: 0, shares: 0, otherMetrics: {} };
                    }
                } catch (fetchError) {
                    console.error(`Failed to fetch engagement for ${item.name} (${item.platform}):`, fetchError.message);
                    showNotification(`Workspace failed for ${item.name}: ${fetchError.message.substring(0, 50)}...`, 'error');
                    continue; // Skip this item
                }

                if (!metrics) continue;

                engagementRecordsToInsert.push({
                    content_id: item.id, timestamp: timestamp,
                    views: metrics.views || 0, likes: metrics.likes || 0, comments: metrics.comments || 0,
                    shares: metrics.shares || 0, other_metrics: metrics.otherMetrics || {}
                });
                contentItemsToUpdate.push({ id: item.id, last_updated: timestamp });
            }

            // Batch Insert/Update to Supabase
             if (engagementRecordsToInsert.length > 0) {
                 try {
                     console.log(`Attempting to insert ${engagementRecordsToInsert.length} engagement records.`);
                     const { error: insertError } = await supabase.from('engagement_data').insert(engagementRecordsToInsert);
                     if (insertError) throw insertError;
                     console.log(`Inserted ${engagementRecordsToInsert.length} engagement records.`);

                     console.log(`Attempting to update ${contentItemsToUpdate.length} content items.`);
                     const { error: updateError } = await supabase.from('content_items').upsert(contentItemsToUpdate);
                     if (updateError) throw updateError; // May need error handling if upsert fails
                     console.log(`Updated last_updated for ${contentItemsToUpdate.length} items.`);

                     // Refresh local data - simplest way is reload all
                     await loadUserData();

                 } catch (error) {
                     console.error("Error saving engagement data to Supabase:", error);
                     showNotification(`Error saving engagement data: ${error.message}`, 'error');
                 }
             } else {
                 console.log("No new engagement records to insert.");
             }
        }


        // Fetch YouTube video engagement
        async function fetchYouTubeEngagement(videoId) {
            const apiKey = apiConfig.youtube?.apiKey;
            if (!apiKey) throw new Error('YouTube API key missing');

             try {
                 const videoStatsUrl = `https://www.googleapis.com/youtube/v3/videos?part=statistics&id=${videoId}&key=${apiKey}`;
                 const response = await fetch(videoStatsUrl);
                 if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error("YouTube API Error:", errorData);
                    // Provide more specific error messages if possible
                    if (response.status === 403) throw new Error(`YouTube API Forbidden (Check Key/Quota/Permissions)`);
                    if (response.status === 404) throw new Error(`YouTube Video Not Found (ID: ${videoId})`);
                    throw new Error(`YouTube API Error: ${response.status} ${response.statusText}. ${errorData.error?.message || ''}`);
                 }
                 const data = await response.json();
                 if (!data.items || data.items.length === 0) {
                     console.warn(`No stats found for YouTube video ID: ${videoId}`);
                     return { views: 0, likes: 0, comments: 0, shares: 0, otherMetrics: { reason: "Not Found or Private"} }; // Return zero metrics
                 }

                 const statistics = data.items[0].statistics;
                 return {
                    views: parseInt(statistics.viewCount) || 0,
                    likes: parseInt(statistics.likeCount) || 0, // Likes might be disabled
                    comments: parseInt(statistics.commentCount) || 0, // Comments might be disabled
                    shares: 0, // Not provided by API
                    otherMetrics: { favorites: parseInt(statistics.favoriteCount) || 0 } // Favorites often 0
                };
             } catch (error) {
                 console.error(`Error fetching YouTube data for ${videoId}:`, error);
                 throw error; // Re-throw the error to be caught by fetchEngagementData
             }
        }


        // Render content items
        function renderContentItems() {
            contentList.innerHTML = ''; // Clear existing list
             if (contentItems.length === 0) {
                 contentList.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">No content items added yet.</td></tr>';
                 return;
             }

            contentItems.forEach(item => {
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-50', 'dark:hover:bg-gray-700'); // Add hover effect

                // Title/Description Cell
                const nameCell = document.createElement('td');
                nameCell.className = 'px-6 py-4';
                const titleDiv = document.createElement('div');
                titleDiv.className = 'font-medium text-gray-900 dark:text-white';
                titleDiv.textContent = item.name;
                nameCell.appendChild(titleDiv);
                if (item.description) {
                    const descriptionDiv = document.createElement('div');
                    descriptionDiv.className = 'text-sm text-gray-500 dark:text-gray-400 mt-1';
                    descriptionDiv.textContent = truncateText(item.description, 50);
                    nameCell.appendChild(descriptionDiv);
                }

                // Platform Cell
                const platformCell = document.createElement('td');
                platformCell.className = 'px-6 py-4 whitespace-nowrap';
                const platformSpan = document.createElement('span');
                platformSpan.textContent = PLATFORMS[item.platform] || item.platform;
                platformSpan.className = `badge ${item.platform}`; // Use platform name as class for styling
                 platformCell.appendChild(platformSpan);
                // Add duration badge for YouTube
                if (item.platform === 'youtube' && item.duration) {
                     const durationSpan = document.createElement('span');
                     durationSpan.className = 'ml-2 inline-flex items-center badge bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-300';
                     durationSpan.innerHTML = `<span class="material-icons text-xs mr-1">timer</span> ${item.duration}`;
                     platformCell.appendChild(durationSpan);
                }


                // Published Date Cell
                const publishedCell = document.createElement('td');
                publishedCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300';
                publishedCell.textContent = formatDate(item.published_date); // Use published_date

                // Added On Cell
                const addedCell = document.createElement('td');
                addedCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400';
                addedCell.textContent = formatDate(item.created_at); // Use created_at

                // URL Cell
                const urlCell = document.createElement('td');
                urlCell.className = 'px-6 py-4 whitespace-normal max-w-xs'; // Limit width
                const urlLink = document.createElement('a');
                urlLink.href = item.url;
                urlLink.target = '_blank';
                urlLink.rel = 'noopener noreferrer';
                urlLink.className = 'text-blue-600 dark:text-blue-400 hover:underline text-sm break-all';
                urlLink.title = item.url;
                urlLink.textContent = truncateText(item.url.replace(/^https?:\/\//, ''), 40); // Shorter, remove protocol
                urlCell.appendChild(urlLink);


                // Actions Cell
                const actionsCell = document.createElement('td');
                actionsCell.className = 'px-6 py-4 whitespace-nowrap text-sm space-x-2'; // Add space between buttons

                 const viewBtn = document.createElement('button');
                 viewBtn.className = 'btn p-1 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 rounded';
                 viewBtn.innerHTML = '<span class="material-icons text-sm">visibility</span>';
                 viewBtn.title = 'View Details';
                 viewBtn.addEventListener('click', () => showContentDetails(item));

                 const updateBtn = document.createElement('button');
                 updateBtn.className = 'btn p-1 bg-blue-100 dark:bg-blue-800 hover:bg-blue-200 dark:hover:bg-blue-700 text-blue-700 dark:text-blue-200 rounded';
                 updateBtn.innerHTML = '<span class="material-icons text-sm">refresh</span>';
                 updateBtn.title = 'Update Data';
                 updateBtn.addEventListener('click', async (e) => {
                     const btn = e.currentTarget;
                     btn.innerHTML = '<span class="material-icons text-sm animate-spin">refresh</span>';
                     btn.disabled = true;
                     await fetchEngagementData([item]); // Fetch for this specific item
                     btn.innerHTML = '<span class="material-icons text-sm">refresh</span>'; // Restore icon
                     btn.disabled = false;
                 });

                 const deleteBtn = document.createElement('button');
                 deleteBtn.className = 'btn p-1 bg-red-100 dark:bg-red-800 hover:bg-red-200 dark:hover:bg-red-700 text-red-700 dark:text-red-200 rounded';
                 deleteBtn.innerHTML = '<span class="material-icons text-sm">delete</span>';
                 deleteBtn.title = 'Delete';
                 deleteBtn.addEventListener('click', () => deleteContent(item.id)); // Use Supabase ID


                actionsCell.appendChild(viewBtn);
                actionsCell.appendChild(updateBtn);
                actionsCell.appendChild(deleteBtn);

                row.appendChild(nameCell);
                row.appendChild(platformCell);
                row.appendChild(publishedCell);
                row.appendChild(addedCell);
                row.appendChild(urlCell);
                row.appendChild(actionsCell);

                contentList.appendChild(row);
            });
        }

        // Render engagement data
        function renderEngagementData() {
             engagementList.innerHTML = ''; // Clear existing list

             // Get latest engagement record for each content item ID
             const latestEngagementByContentId = {};
             engagementData.forEach(engagement => {
                 if (!latestEngagementByContentId[engagement.content_id] ||
                     new Date(engagement.timestamp) > new Date(latestEngagementByContentId[engagement.content_id].timestamp)) {
                     latestEngagementByContentId[engagement.content_id] = engagement;
                 }
             });

              if (Object.keys(latestEngagementByContentId).length === 0) {
                 engagementList.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">No engagement data available. Add content and click Refresh.</td></tr>';
                 return;
             }


            Object.values(latestEngagementByContentId).forEach(engagement => {
                const contentItem = contentItems.find(c => c.id === engagement.content_id);
                if (!contentItem) return; // Skip if content item not found (e.g., deleted)

                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-50', 'dark:hover:bg-gray-700');

                 // Content Name Cell
                const nameCell = document.createElement('td');
                nameCell.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white';
                nameCell.textContent = truncateText(contentItem.name, 30);
                nameCell.title = contentItem.name;

                 // Platform Cell
                 const platformCell = document.createElement('td');
                 platformCell.className = 'px-6 py-4 whitespace-nowrap';
                 const platformSpan = document.createElement('span');
                 platformSpan.textContent = PLATFORMS[contentItem.platform] || contentItem.platform;
                 platformSpan.className = `badge ${contentItem.platform}`;
                 platformCell.appendChild(platformSpan);

                 // Views Cell
                 const viewsCell = document.createElement('td');
                 viewsCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200 text-right';
                 viewsCell.textContent = (engagement.views || 0).toLocaleString();

                 // Total Hours Cell (YouTube only)
                 const totalHoursCell = document.createElement('td');
                 totalHoursCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200 text-right';
                 if (contentItem.platform === 'youtube' && contentItem.duration) {
                     const hours = calculateWatchHours(engagement.views, contentItem.duration);
                     totalHoursCell.textContent = hours.formatted;
                     totalHoursCell.title = hours.title;
                 } else {
                     totalHoursCell.textContent = '-';
                 }

                 // Likes Cell
                 const likesCell = document.createElement('td');
                 likesCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200 text-right';
                 likesCell.textContent = (engagement.likes || 0).toLocaleString();

                 // Comments Cell
                 const commentsCell = document.createElement('td');
                 commentsCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200 text-right';
                 commentsCell.textContent = (engagement.comments || 0).toLocaleString();

                 // Last Updated Cell
                const updatedCell = document.createElement('td');
                updatedCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400';
                updatedCell.textContent = formatDateTime(engagement.timestamp); // Timestamp of the engagement record

                row.appendChild(nameCell);
                row.appendChild(platformCell);
                row.appendChild(viewsCell);
                row.appendChild(totalHoursCell);
                row.appendChild(likesCell);
                row.appendChild(commentsCell);
                row.appendChild(updatedCell);

                engagementList.appendChild(row);
            });
        }

         // Calculate estimated watch hours for YouTube
         function calculateWatchHours(views, durationString, avgWatchPercentage = 0.55) {
             if (!views || !durationString) return { value: 0, formatted: '-', title: 'N/A' };

             try {
                 const durationParts = durationString.split(':').map(part => parseInt(part, 10));
                 let durationInHours = 0;
                 if (durationParts.length === 2) { // MM:SS
                     durationInHours = (durationParts[0] * 60 + durationParts[1]) / 3600;
                 } else if (durationParts.length === 3) { // HH:MM:SS
                     durationInHours = durationParts[0] + (durationParts[1] * 60 + durationParts[2]) / 3600;
                 } else { return { value: 0, formatted: '-', title: 'Invalid duration format' }; } // Invalid format

                 const totalHours = views * durationInHours * avgWatchPercentage;

                 let formattedHours;
                 if (totalHours < 0.1) { formattedHours = totalHours.toFixed(3); }
                 else if (totalHours < 10) { formattedHours = totalHours.toFixed(2); }
                 else if (totalHours < 1000) { formattedHours = totalHours.toFixed(1); }
                 else { formattedHours = Math.round(totalHours).toLocaleString(); }

                 return {
                     value: totalHours,
                     formatted: formattedHours,
                     title: `Est. hours (${views.toLocaleString()} views  ${durationString}  ${Math.round(avgWatchPercentage * 100)}% avg retention)`
                 };
             } catch (e) {
                 console.error("Error calculating watch hours:", e);
                 return { value: 0, formatted: '-', title: 'Calculation error' };
             }
         }


        // Show content details modal
        async function showContentDetails(contentItem) {
             const modalTitle = document.getElementById('modal-title');
             const modalContent = document.getElementById('modal-content');
             modalTitle.textContent = contentItem.name;
             modalContent.innerHTML = '<p class="text-gray-500 dark:text-gray-400 p-4">Loading engagement history...</p>'; // Loading state
             contentModal.classList.remove('hidden');

             try {
                 const { data: contentEngagements, error } = await supabase
                     .from('engagement_data')
                     .select('*')
                     .eq('content_id', contentItem.id)
                     .order('timestamp', { ascending: false });

                 if (error) throw error;

                 const latestEngagement = contentEngagements?.[0];
                 const watchHours = (contentItem.platform === 'youtube' && contentItem.duration && latestEngagement)
                    ? calculateWatchHours(latestEngagement.views, contentItem.duration)
                    : { formatted: '-', title: 'N/A' };


                 const html = `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="text-md font-medium mb-2 dark:text-white">Content Information</h4>
                                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg space-y-2 text-sm">
                                    ${contentItem.description ? `<div class="pb-2 border-b border-gray-200 dark:border-gray-600"><p class="text-gray-700 dark:text-gray-300">${contentItem.description}</p></div>` : ''}
                                    <p><span class="text-gray-500 dark:text-gray-400 w-24 inline-block">Platform:</span> <span class="font-medium dark:text-white">${PLATFORMS[contentItem.platform]}</span> ${contentItem.platform === 'youtube' && contentItem.duration ? `<span class="ml-2 inline-flex items-center badge bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-300"><span class="material-icons text-xs mr-1">timer</span> ${contentItem.duration}</span>` : ''}</p>
                                    <p><span class="text-gray-500 dark:text-gray-400 w-24 inline-block">Published:</span> <span class="font-medium dark:text-white">${formatDate(contentItem.published_date)}</span></p>
                                    <p><span class="text-gray-500 dark:text-gray-400 w-24 inline-block">URL:</span> <a href="${contentItem.url}" target="_blank" rel="noopener noreferrer" class="text-blue-600 dark:text-blue-400 hover:underline break-all">${contentItem.url}</a></p>
                                    <p><span class="text-gray-500 dark:text-gray-400 w-24 inline-block">Added:</span> <span class="font-medium dark:text-white">${formatDateTime(contentItem.created_at)}</span></p>
                                    <p><span class="text-gray-500 dark:text-gray-400 w-24 inline-block">Last Update:</span> <span class="font-medium dark:text-white">${formatDateTime(contentItem.last_updated) || 'Never'}</span></p>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-md font-medium mb-2 dark:text-white">Latest Engagement</h4>
                                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                                    ${latestEngagement ? `
                                        <div class="grid grid-cols-2 gap-4">
                                            ${renderMetricCard('visibility', 'Views', latestEngagement.views, 'blue')}
                                            ${renderMetricCard('thumb_up', 'Likes', latestEngagement.likes, 'red')}
                                            ${renderMetricCard('comment', 'Comments', latestEngagement.comments, 'green')}
                                            ${renderMetricCard('share', 'Shares', latestEngagement.shares, 'purple')}
                                             ${contentItem.platform === 'youtube' ? renderMetricCard('schedule', 'Watch Hours', watchHours.formatted, 'yellow', watchHours.title, 'col-span-2') : ''}
                                        </div>
                                        <div class="mt-2 text-xs text-right text-gray-500 dark:text-gray-400">
                                            As of ${formatDateTime(latestEngagement.timestamp)}
                                        </div>
                                    ` : '<p class="text-gray-500 dark:text-gray-400">No engagement data available</p>'}
                                </div>
                            </div>
                        </div>

                        ${contentEngagements.length > 1 ? `
                            <div>
                                <h4 class="text-md font-medium mb-2 dark:text-white">Engagement History</h4>
                                <div class="overflow-x-auto max-h-60 border border-gray-200 dark:border-gray-600 rounded-lg">
                                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 text-sm">
                                        <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0">
                                            <tr>
                                                <th scope="col" class="px-3 py-2 text-left font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Date</th>
                                                <th scope="col" class="px-3 py-2 text-right font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Views</th>
                                                ${contentItem.platform === 'youtube' ? `<th scope="col" class="px-3 py-2 text-right font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Hours</th>` : ''}
                                                <th scope="col" class="px-3 py-2 text-right font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Likes</th>
                                                <th scope="col" class="px-3 py-2 text-right font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Comments</th>
                                                <th scope="col" class="px-3 py-2 text-right font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Shares</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                            ${contentEngagements.map(eng => {
                                                 const historyHours = (contentItem.platform === 'youtube' && contentItem.duration) ? calculateWatchHours(eng.views, contentItem.duration) : { formatted: '-' };
                                                 return `
                                                <tr>
                                                    <td class="px-3 py-2 whitespace-nowrap text-gray-500 dark:text-gray-400">${formatDateTime(eng.timestamp)}</td>
                                                    <td class="px-3 py-2 whitespace-nowrap text-gray-900 dark:text-gray-200 text-right">${(eng.views || 0).toLocaleString()}</td>
                                                    ${contentItem.platform === 'youtube' ? `<td class="px-3 py-2 whitespace-nowrap text-gray-900 dark:text-gray-200 text-right">${historyHours.formatted}</td>` : ''}
                                                    <td class="px-3 py-2 whitespace-nowrap text-gray-900 dark:text-gray-200 text-right">${(eng.likes || 0).toLocaleString()}</td>
                                                    <td class="px-3 py-2 whitespace-nowrap text-gray-900 dark:text-gray-200 text-right">${(eng.comments || 0).toLocaleString()}</td>
                                                    <td class="px-3 py-2 whitespace-nowrap text-gray-900 dark:text-gray-200 text-right">${(eng.shares || 0).toLocaleString()}</td>
                                                </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
                modalContent.innerHTML = html;

             } catch (error) {
                 console.error("Error loading content details:", error);
                 modalContent.innerHTML = `<p class="text-red-500 p-4">Error loading details: ${error.message}</p>`;
             }
        }

         // Helper to render metric cards in modal
         function renderMetricCard(icon, label, value, color, title = '', extraClasses = '') {
            const colors = {
                 blue: 'bg-blue-100 dark:bg-blue-900 text-blue-500 dark:text-blue-300',
                 red: 'bg-red-100 dark:bg-red-900 text-red-500 dark:text-red-300',
                 green: 'bg-green-100 dark:bg-green-900 text-green-500 dark:text-green-300',
                 purple: 'bg-purple-100 dark:bg-purple-900 text-purple-500 dark:text-purple-300',
                 yellow: 'bg-yellow-100 dark:bg-yellow-900 text-yellow-500 dark:text-yellow-300'
            };
            const colorClasses = colors[color] || 'bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-300';
            return `
                <div class="text-center ${extraClasses}" ${title ? `title="${title}"` : ''}>
                     <div class="p-3 rounded-lg flex flex-col items-center ${colorClasses}">
                         <span class="material-icons">${icon}</span>
                         <p class="text-gray-500 dark:text-gray-400 text-xs mt-1">${label}</p>
                         <p class="text-xl font-bold text-gray-900 dark:text-white">${(value || 0).toLocaleString()}</p>
                     </div>
                 </div>
             `;
         }


        // Delete content from Supabase
        async function deleteContent(contentItemId) {
            if (!currentUser) return;
            if (confirm('Delete this content item and its engagement data? This cannot be undone.')) {
                console.log("Attempting to delete content item:", contentItemId);
                 try {
                    // RLS Policies should ensure user owns the item.
                    // Cascade delete on the DB relationship is preferred for deleting engagement data.
                    const { error } = await supabase
                        .from('content_items')
                        .delete()
                        .eq('id', contentItemId);
                        // .eq('user_id', currentUser.id); // RLS makes this redundant but safe

                    if (error) throw error;

                    console.log("Content deleted successfully:", contentItemId);
                    showNotification('Content deleted successfully', 'success');

                     // Remove locally and re-render, or just reload all data
                     // Easiest: Reload all data
                     await loadUserData();

                 } catch (error) {
                     console.error("Error deleting content:", error);
                     showNotification(`Failed to delete content: ${error.message}`, 'error');
                 }
            }
        }

        // Update statistics display
        function updateStats() {
            totalContentEl.textContent = contentItems.length;

            let totalViews = 0;
            let engagementsByPlatform = {};
            const latestEngagementByContentId = {};

            engagementData.forEach(engagement => {
                if (!latestEngagementByContentId[engagement.content_id] ||
                    new Date(engagement.timestamp) > new Date(latestEngagementByContentId[engagement.content_id].timestamp)) {
                    latestEngagementByContentId[engagement.content_id] = engagement;
                }
            });

            Object.values(latestEngagementByContentId).forEach(engagement => {
                const contentItem = contentItems.find(item => item.id === engagement.content_id);
                if (!contentItem) return;
                totalViews += (engagement.views || 0);
                engagementsByPlatform[contentItem.platform] = (engagementsByPlatform[contentItem.platform] || 0) + (engagement.views || 0);
            });

            totalEngagementsEl.textContent = totalViews.toLocaleString();

             const topPlatform = Object.keys(engagementsByPlatform).length > 0
                 ? Object.keys(engagementsByPlatform).reduce((a, b) => engagementsByPlatform[a] > engagementsByPlatform[b] ? a : b)
                 : null;

            topPlatformEl.textContent = topPlatform ? PLATFORMS[topPlatform] : '-';
        }

        // Render charts
        function renderCharts() {
             const platformCtx = document.getElementById('platform-chart').getContext('2d');
             const contentCtx = document.getElementById('content-chart').getContext('2d');

             // Get latest engagement data for each content ID
             const latestEngagementByContentId = {};
             engagementData.forEach(engagement => {
                 if (!latestEngagementByContentId[engagement.content_id] ||
                     new Date(engagement.timestamp) > new Date(latestEngagementByContentId[engagement.content_id].timestamp)) {
                     latestEngagementByContentId[engagement.content_id] = engagement;
                 }
             });

             // Platform Chart Data
             const platformData = {};
             Object.values(latestEngagementByContentId).forEach(engagement => {
                 const contentItem = contentItems.find(item => item.id === engagement.content_id);
                 if (!contentItem) return;
                 platformData[contentItem.platform] = (platformData[contentItem.platform] || 0) + (engagement.views || 0);
             });

             // Content Chart Data (Top 5 by views)
             const contentEngagementMap = {};
             Object.values(latestEngagementByContentId).forEach(engagement => {
                  const contentItem = contentItems.find(item => item.id === engagement.content_id);
                  if (!contentItem) return;
                  contentEngagementMap[contentItem.name] = engagement.views || 0;
             });
             const topContent = Object.entries(contentEngagementMap)
                 .sort(([,a], [,b]) => b - a) // Sort by views descending
                 .slice(0, 5); // Take top 5

             // Platform Chart (Doughnut)
             if (platformChart) platformChart.destroy();
             platformChart = new Chart(platformCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(platformData).map(p => PLATFORMS[p] || p),
                    datasets: [{
                        data: Object.values(platformData),
                         backgroundColor: Object.keys(platformData).map(p => {
                             if (p === 'youtube') return '#FF0000';
                             if (p === 'servicenow') return '#00c487';
                             if (p === 'linkedin') return '#0A66C2';
                             return '#6B7280'; // Default gray
                         })
                    }]
                },
                 options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
             });

             // Content Chart (Horizontal Bar)
             if (contentChart) contentChart.destroy();
             contentChart = new Chart(contentCtx, {
                 type: 'bar',
                 data: {
                     labels: topContent.map(item => truncateText(item[0], 20)), // Truncate labels
                     datasets: [{
                         label: 'Views',
                         data: topContent.map(item => item[1]),
                         backgroundColor: '#00c487'
                     }]
                 },
                 options: {
                     indexAxis: 'y', // Horizontal bar chart
                     responsive: true,
                     scales: { x: { beginAtZero: true } },
                     plugins: { legend: { display: false } }
                 }
             });

             updateChartsForColorMode(); // Apply dark/light mode styles
        }

        // Refresh all engagement data
        async function refreshEngagementDataForAllUserItems() {
            if (!currentUser || contentItems.length === 0) {
                 showNotification('No content items to refresh.', 'info');
                 return;
            }
            console.log("Refreshing engagement data for all user items...");
            const refreshBtn = document.getElementById('refresh-data');
            const refreshAllBtn = document.getElementById('refresh-all-data');
            refreshBtn.disabled = true;
            refreshAllBtn.disabled = true;
            refreshBtn.innerHTML = '<span class="material-icons animate-spin">refresh</span>';
            refreshAllBtn.innerHTML = '<span class="material-icons animate-spin">refresh</span> Refreshing All...';

             try {
                 await fetchEngagementData(contentItems); // Fetch for all items
                 showNotification('Engagement data refreshed successfully', 'success');
             } catch (error) {
                 console.error('Error refreshing all data:', error);
                 // fetchEngagementData shows individual errors, maybe a summary here
                 showNotification('Error occurred during data refresh.', 'error');
             } finally {
                 refreshBtn.disabled = false;
                 refreshAllBtn.disabled = false;
                 refreshBtn.innerHTML = '<span class="material-icons mr-1">refresh</span> Refresh Data';
                 refreshAllBtn.innerHTML = '<span class="material-icons mr-1">refresh</span> Refresh All';
             }
        }


        // Save API configuration to Supabase
        async function saveApiConfig() {
            if (!currentUser) return;
             const button = document.getElementById('save-api-config');
             button.disabled = true;

             // Prepare data for upsert based on unique (user_id, platform)
             const apiConfigsToSave = [
                 { user_id: currentUser.id, platform: 'youtube', config: { apiKey: document.getElementById('youtube-api-key').value } },
                 { user_id: currentUser.id, platform: 'servicenow', config: { instance: document.getElementById('servicenow-instance').value, username: document.getElementById('servicenow-username').value, password: document.getElementById('servicenow-password').value } },
                 { user_id: currentUser.id, platform: 'linkedin', config: { clientId: document.getElementById('linkedin-client-id').value, clientSecret: document.getElementById('linkedin-client-secret').value } },
             ];

             try {
                 // Ensure table has unique constraint on (user_id, platform)
                 const { error } = await supabase
                     .from('api_config')
                     .upsert(apiConfigsToSave, { onConflict: 'user_id, platform' });

                 if (error) throw error;

                 console.log("API configuration saved.");
                 // Update local state
                 apiConfigsToSave.forEach(cfg => { apiConfig[cfg.platform] = cfg.config; });
                 updateApiConfigUI();
                 showNotification('API configuration saved successfully', 'success');

             } catch (error) {
                 console.error("Error saving API config:", error);
                 showNotification(`Error saving API config: ${error.message}`, 'error');
             } finally {
                 button.disabled = false;
             }
        }


        // Update API configuration UI display
        function updateApiConfigUI() {
             // YouTube
             const ytApiKey = apiConfig.youtube?.apiKey;
             document.getElementById('youtube-api-key').value = ytApiKey || '';
             document.getElementById('youtube-api-status').textContent = ytApiKey ? 'Configured' : 'Not Configured';
             document.getElementById('youtube-api-status').className = `ml-2 badge ${ytApiKey ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300'}`;

             // ServiceNow
             const snConfig = apiConfig.servicenow;
             document.getElementById('servicenow-instance').value = snConfig?.instance || '';
             document.getElementById('servicenow-username').value = snConfig?.username || '';
             document.getElementById('servicenow-password').value = snConfig?.password || ''; // Note: Storing passwords client-accessible is insecure
             const snConfigured = snConfig?.instance && snConfig?.username; // Basic check
             document.getElementById('servicenow-api-status').textContent = snConfigured ? 'Configured' : 'Not Configured';
             document.getElementById('servicenow-api-status').className = `ml-2 badge ${snConfigured ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300'}`;

             // LinkedIn
             const liConfig = apiConfig.linkedin;
             document.getElementById('linkedin-client-id').value = liConfig?.clientId || '';
             document.getElementById('linkedin-client-secret').value = liConfig?.clientSecret || ''; // Note: Storing secrets client-accessible is insecure
             const liConfigured = liConfig?.clientId && liConfig?.clientSecret;
             document.getElementById('linkedin-api-status').textContent = liConfigured ? 'Configured' : 'Not Configured';
             document.getElementById('linkedin-api-status').className = `ml-2 badge ${liConfigured ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300'}`;
        }

        // Test YouTube API
        async function testYouTubeApi() {
            const apiKey = document.getElementById('youtube-api-key').value;
            if (!apiKey) { showNotification('Please enter a YouTube API key', 'error'); return; }
             const button = document.getElementById('test-youtube-api');
             button.disabled = true;

            try {
                 const testVideoId = 'dQw4w9WgXcQ'; // A known public video ID
                 const testUrl = `https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${testVideoId}&key=${apiKey}`;
                 const response = await fetch(testUrl);
                 if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`API Test Failed: ${response.status} ${response.statusText}. ${errorData.error?.message || ''}`);
                 }
                 const data = await response.json();
                 if (!data.items || data.items.length === 0) throw new Error('API Test Failed: No results returned');

                 showNotification('YouTube API connection successful!', 'success');
                 // Optionally save the valid key immediately
                 apiConfig.youtube = { apiKey: apiKey };
                 await saveApiConfig(); // Save all configs including the tested one
                 updateApiConfigUI(); // Refresh UI status

            } catch (error) {
                console.error('Error testing YouTube API:', error);
                showNotification(`YouTube API Error: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
            }
        }

        // Test ServiceNow API (Simulation)
        async function testServiceNowApi() {
             // This should ideally make a real, simple, authenticated call to the instance URL
             showNotification('ServiceNow API test is simulated.', 'info');
             console.log("Simulating ServiceNow API Test");
        }

        // Test LinkedIn API (Simulation)
        async function testLinkedInApi() {
             // This should ideally initiate OAuth flow or test a stored token if applicable
             showNotification('LinkedIn API test is simulated.', 'info');
             console.log("Simulating LinkedIn API Test");
        }


        // --- Helper Functions ---
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
             try {
                 const date = new Date(dateString);
                 // Check if date is valid after parsing
                 if (isNaN(date.getTime())) return 'Invalid Date';
                 return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
             } catch (e) { return 'Invalid Date'; }
        }

        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return 'N/A';
             try {
                 const date = new Date(dateTimeString);
                 if (isNaN(date.getTime())) return 'Invalid Date';
                 return date.toLocaleString(undefined, { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
             } catch (e) { return 'Invalid Date'; }
        }

        function truncateText(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        // Simple string hash function for seeding simulations
        function hashCode(str) {
             if (!str) return 0;
             let hash = 0;
             for (let i = 0; i < str.length; i++) {
                 const char = str.charCodeAt(i);
                 hash = ((hash << 5) - hash) + char;
                 hash = hash & hash; // Convert to 32bit integer
             }
             return Math.abs(hash);
        }
         // Seeded random number generator for simulations
         function seededRandom(seed) {
             return function() {
                 seed = (seed * 9301 + 49297) % 233280;
                 return seed / 233280;
             };
         }


         // Setup collapsible sections
         function setupCollapsibleSections() {
             const sections = [
                 { toggleId: 'toggle-add-content', bodyId: 'add-content-body', storageKey: 'addContentCollapsed' },
                 { toggleId: 'toggle-content-library', bodyId: 'content-library-body', storageKey: 'contentLibraryCollapsed' },
                 { toggleId: 'toggle-engagement-data', bodyId: 'engagement-data-body', storageKey: 'engagementDataCollapsed' }
             ];

             sections.forEach(({ toggleId, bodyId, storageKey }) => {
                 const toggle = document.getElementById(toggleId);
                 const body = document.getElementById(bodyId);
                 const icon = toggle?.querySelector('.material-icons'); // Safely access icon

                 if (toggle && body && icon) {
                     // Check saved state
                     const isCollapsed = localStorage.getItem(storageKey) === 'true';
                     if (isCollapsed) {
                         body.classList.add('hidden');
                         icon.classList.add('rotate-180');
                     } else {
                         body.classList.remove('hidden'); // Ensure it's visible if not collapsed
                         icon.classList.remove('rotate-180');
                     }


                     toggle.addEventListener('click', () => {
                         const collapsing = body.classList.toggle('hidden');
                         icon.classList.toggle('rotate-180', collapsing);
                         localStorage.setItem(storageKey, collapsing);
                     });
                 } else {
                     console.warn(`Collapsible section elements not found for ${toggleId}/${bodyId}`);
                 }
             });
         }

         // Show Notifications Helper
         function showNotification(message, type = 'info') {
             const bgColor = type === 'success' ? 'bg-green-500' : (type === 'error' ? 'bg-red-500' : 'bg-blue-500');
             const icon = type === 'success' ? 'check_circle' : (type === 'error' ? 'error' : 'info');

             const notification = document.createElement('div');
             notification.className = `fixed bottom-4 right-4 text-white px-4 py-2 rounded shadow-lg ${bgColor} z-[100]`; // Ensure high z-index
             notification.innerHTML = `<div class="flex items-center"><span class="material-icons mr-2 text-sm">${icon}</span> <span class="text-sm">${message}</span></div>`;
             document.body.appendChild(notification);

             setTimeout(() => {
                 notification.remove();
             }, type === 'error' ? 6000 : 3500); // Show errors slightly longer
         }

        // --- Initialize ---
        // Initialize the app when the page loads
        window.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>
